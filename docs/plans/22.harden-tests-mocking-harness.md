# 22.harden-tests-mocking-harness

Problem Statement
-----------------
Tests are currently flaky, rely on live network calls, and have inconsistent test setup across the codebase. This causes CI instability and developer friction. We need a single, repeatable test harness with centralized mocks and helpers to ensure deterministic, resilient tests.

Requirements
------------
- Create a deterministic Jest environment using `.env.test` and controlled NUXT_PUBLIC_* env values.
- Standardize `jest.setup.js` to initialize environment, mock global fetch, and wire up MSW.
- Centralize mocks and MSW handlers in `tests/mocks` and provide a test server utility (start, reset, teardown).
- Provide test factories and fixtures to replace ad-hoc test data in tests.
- Ensure CI fails for live network calls, un-mocked external dependencies, or console errors.

Technical Approach
------------------
Use MSW (Mock Service Worker) as the primary network mocking tool and create helper utilities for starting/stopping the server in local and CI contexts. Build test factories and fixtures in `tests/mocks/` and provide simple importable helpers for tests.

Implementation Steps
--------------------
1. Add `.env.test` and update `jest.setup.js` to load it and set deterministic NUXT_PUBLIC_* values.
2. Add `tests/mocks` directory with MSW handlers for commonly used endpoints (firebase, firebase-admin, AI provider, storage service).
3. Implement `tests/helpers/testServer.ts` with `setup`, `reset`, `teardown` functions and test utilities to toggle responses.
4. Create test factories in `tests/mocks/factories` and shared fixtures in `tests/mocks/fixtures`.
5. Add a Jest rule to fail if any test triggers a network call (e.g., using MSW and `node:unhandledRejection`, or custom console error checks).
6. Create example migrations in `tests/services/*` showing how to switch tests to the harness.
7. Add CI checks (GitHub Actions) to prevent live network calls and fail on console errors.

Testing Strategy
----------------
- Validate harness start/stop across Node.js and browser test environments.
- Add smoke tests for handlers to ensure each service is covered by MSW handlers.
- Add tests demonstrating factory usage and ensuring determinism.
- Create CI workflow that runs Jest with the harness and checks for console errors and network calls.

Dependencies
------------
- This plan depends on Task 21 (Implement Input Validation and Sanitization Framework) and other testing-related tasks.

Risks & Mitigation
------------------
- Risk: Flaky tests due to async timing - Mitigate via awaiting mock-server ready and using deterministic timestamps.
- Risk: Missing handler coverage - Mitigate by adding CI checks and smoke tests that require handlers to be in place before tests run.

Done
